<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Table 17 Parser</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
}
textarea {
    width: 100%;
    height: 180px;
    font-family: monospace;
    font-size: 14px;
}
button {
    margin-top: 10px;
    padding: 8px 16px;
}
pre {
    background: #f9f9f9;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-family: monospace;
}
</style>
</head>
<body>
<h2>Table 17 Parser</h2>
<textarea id="input" placeholder="Paste full Table 17 hex string here..."></textarea>
<br>
<button onclick="loadSample()">Load Sample</button>
<button onclick="parseTable17()">Parse</button>
<pre id="output" style="display:none"></pre>
<script>
function parseTable17() {
    const hexData = document.getElementById("input").value.trim().toUpperCase();
    const output = document.getElementById("output");
    output.innerHTML = "";
    output.style.display = "none";

    if (!hexData) {
        alert("Paste hex string first");
        return;
    }

    let offset = 0;

    function readHex(length) {
        const str = hexData.substr(offset, length);
        offset += length;
        return str;
    }

    function hexToInt(hexStr) {
        return parseInt(hexStr, 16);
    }

    let result = "";

    const currencyCode = readHex(2);
    const unknown = readHex(4);
    const intervalMinutes = readHex(4);
    const batchStartTime = readHex(8);

    result += `Currency Code: ${currencyCode}\n`;
    result += `Unknown Field: ${unknown}\n`;
    result += `Interval (minutes): ${hexToInt(intervalMinutes)}\n`;
    result += `Batch Start Time: ${batchStartTime} (MMDDHHMM)\n\n`;

    let subbatchPresence = "";
    let firstBitmapHex = readHex(16);
    let bitmapBinary = BigInt('0x' + firstBitmapHex).toString(2).padStart(64, '0');

    let signBit = bitmapBinary[0];
    subbatchPresence += bitmapBinary.substring(1); // Ignore first bit (sign bit)

    while (signBit === '1') {
        const nextBitmapHex = readHex(16);
        const nextBitmapBinary = BigInt('0x' + nextBitmapHex).toString(2).padStart(64, '0');
        signBit = nextBitmapBinary[0]; // check new sign bit
        subbatchPresence += nextBitmapBinary.substring(1); // ignore sign bit
    }

    const startMonth = parseInt(batchStartTime.substring(0, 2));
    const startDay = parseInt(batchStartTime.substring(2, 4));
    let currentHour = parseInt(batchStartTime.substring(4, 6), 10);
    let currentDate = startDay;
    let currentMonth = startMonth;

    result += `--- Hours having Subbatch Data ---\n`;

    const hoursWithData = []; // Store for later parsing

    for (let i = 0; i < subbatchPresence.length; i++) {
        const bit = subbatchPresence[i];

        if (bit === '1') {
            result += `Hour: ${currentHour} on Date: ${currentMonth}-${currentDate}\n`;
            hoursWithData.push({ hour: currentHour, date: `${currentMonth}-${currentDate}` });
        }

        currentHour++;
        if (currentHour === 24) { // roll over to next day
            currentHour = 0;
            currentDate++;
            // In real world, you might need month days logic; for now assume simple increment
        }
    }

    result += `\n--- Subbatch Data Parsing ---\n`;

    for (let i = 0; i < hoursWithData.length; i++) {
        const subbatch = hoursWithData[i];

        result += `\nSubbatch for Hour ${subbatch.hour} (Date: ${subbatch.date})\n`;

        const positiveCount = readHex(4);
        const positiveTotal = readHex(12);
        const negativeCount = readHex(4);
        const negativeTotal = readHex(12);
        const topUpPositiveCount = readHex(4);
        const topUpPositiveTotal = readHex(12);
        const topUpNegativeCount = readHex(4);
        const topUpNegativeTotal = readHex(12);

        result += `Positive Count: ${positiveCount}\n`;
        result += `Positive Total: ${positiveTotal}\n`;
        result += `Negative Count: ${negativeCount}\n`;
        result += `Negative Total: ${negativeTotal}\n`;
        result += `Top-Up Positive Count: ${topUpPositiveCount}\n`;
        result += `Top-Up Positive Total: ${topUpPositiveTotal}\n`;
        result += `Top-Up Negative Count: ${topUpNegativeCount}\n`;
        result += `Top-Up Negative Total: ${topUpNegativeTotal}\n`;
    }

    output.textContent = result;
    output.style.display = "block";
}

function loadSample() {
    document.getElementById("input").value = "0103560060120415007000000000000000000000000000000000000000000000000003000000021000000000000000000000000000000000000000000000000000000400000003800000000000000000000000000000000000000000000000000000020000000100000000000000000000";
}
</script>
</body>
</html>
