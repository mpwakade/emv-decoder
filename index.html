<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EMV Field 60 / 9F10 Parser</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { background:#020617; color:#e5e7eb; font-family:Consolas, monospace; padding:20px; }
textarea { width:100%; height:180px; background:#020617; color:#22c55e; border:1px solid #334155; padding:10px; font-family:monospace; margin-top:10px; }
button { background:#2563eb; border:none; color:white; padding:10px 18px; margin:10px 0; border-radius:6px; cursor:pointer; }
.card { background:#0b1224; border:1px solid #1f2937; border-radius:8px; padding:14px; margin-top:14px; }
pre { white-space:pre-wrap; word-break:break-all; }
.label { color:#38bdf8; }
.ok { color:#22c55e; }
.err { color:#f87171; }
input[type=radio] { margin-right:4px; }
</style>
</head>
<body>

<h2>EMV Parser: Field 60 / 9F10</h2>

<label><input type="radio" name="parser" value="f60" checked> Field 60 Parser</label>
<label><input type="radio" name="parser" value="9f10"> 9F10 (IAD) Parser</label>

<textarea id="emvhex" placeholder="Paste full hex string here..."></textarea>
<br>
<button onclick="parseEMV()">Parse</button>
<div id="output"></div>

<script>
// ---------------- HEX → ASCII
function hexToAscii(hex) {
    let out = "";
    for (let i = 0; i < hex.length; i += 2) {
        const byte = parseInt(hex.substr(i,2),16);
        out += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : ".";
    }
    return out;
}

// ---------------- FIELD 60 PARSER
function parseField60(hex){
    const outDiv = [];
    let i=0, block=1;

    while(i < hex.length){
        if(i+14>hex.length){ outDiv.push(`<div class="card err">❌ Incomplete header at block ${block}</div>`); break; }

        const version = hex.substr(i,4); i+=4;
        const blockId = hex.substr(i,4); i+=4;
        const tableId = hex.substr(i,2); i+=2;
        const lenStr  = hex.substr(i,4); i+=4;

        const length = parseInt(lenStr,10); // decimal length
        const dataHexLen = length*2;

        if(isNaN(length)){ outDiv.push(`<div class="card err">❌ Invalid length at block ${block}</div>`); break; }
        if(i+dataHexLen>hex.length){ outDiv.push(`<div class="card err">❌ Length overflow at block ${block}</div>`); break; }

        const dataHex = hex.substr(i,dataHexLen); i+=dataHexLen;
        const ascii = hexToAscii(dataHex);

        outDiv.push(`<div class="card">
<pre class="ok">
Block ${block}
<span class="label">Version:</span> ${version}
<span class="label">Block ID:</span> ${blockId}
<span class="label">Table ID:</span> ${tableId}
<span class="label">Data Length:</span> ${length} bytes
<span class="label">Data (HEX):</span>
${dataHex}
<span class="label">Data (ASCII):</span>
${ascii}
</pre></div>`);

        block++;
    }
    return outDiv.join("");
}

// ---------------- 9F10 (IAD) PARSER
function parse9F10(hex){
    if(hex.length < 28) return `<div class="card err">❌ 9F10 hex too short</div>`;
    let iad = hex;

    const TAG = iad.substr(0,4);
    const LEN = iad.substr(4,2);
    const LENI = iad.substr(6,2);
    const CAII = iad.substr(8,2);
    const DKI = iad.substr(10,2);
    const CVR = iad.substr(12,16);
    const CTR = iad.substr(28,28);
    const IDD = iad.substr(56,14);

    function bin8(hexByte){ return parseInt(hexByte,16).toString(2).padStart(8,'0'); }
    const b = []; for(let k=0;k<8;k++) b.push(bin8(CVR.substr(k*2,2)));

    return `<div class="card">
<pre class="ok">
TAG             : ${TAG}
Length          : ${LEN}
Length Indicator: ${LENI}

CAII           : ${CAII} (bits: ${bin8(CAII)})
  8-5 bits: ${bin8(CAII).substr(0,4)} — RuPay Version IAD Format
  4-1 bits: ${bin8(CAII).substr(4,4)} — Other

DKI            : ${DKI}

CVR (8 bytes)  : ${CVR}
[CVR b1]  : ${b[0]}
[CVR b2]  : ${b[1]}
[CVR b3]  : ${b[2]}
[CVR b4]  : ${b[3]}
[CVR b5]  : ${b[4]}
[CVR b6]  : ${b[5]}
[CVR b7]  : ${b[6]}
[CVR b8]  : ${b[7]}

Counters (28-55): ${CTR}
IDD (56-69): ${IDD}
</pre></div>`;
}

// ---------------- MAIN PARSER
function parseEMV(){
    const hex = document.getElementById("emvhex").value.trim().toUpperCase();
    const type = document.querySelector('input[name="parser"]:checked').value;
    const out = document.getElementById("output");
    out.innerHTML = "";

    if(hex.length === 0){ out.innerHTML = `<div class="card err">❌ Paste hex string first</div>`; return; }

    if(type==='f60') out.innerHTML = parseField60(hex);
    else if(type==='9f10') out.innerHTML = parse9F10(hex);
}
</script>
</body>
</html>
